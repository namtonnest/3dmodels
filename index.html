<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>Location Locations</title>
    <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no" />
    <link href="https://api.mapbox.com/mapbox-gl-js/v3.3.0/mapbox-gl.css" rel="stylesheet" />
    <script src="https://api.mapbox.com/mapbox-gl-js/v3.3.0/mapbox-gl.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            margin: 0;
            padding: 0;
            overflow: hidden;
            font-family: 'Arial', sans-serif;
        }
        #map {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 100%;
            height: 100%;
        }
        .draggable {
            position: relative;
            top: 10px;
            left: 10px;
            width: 50px;
            height: 50px;
            background-color: #ff0000; /* Red color for Truck */
            color: white;
            text-align: center;
            line-height: 50px;
            cursor: move;
            font-weight: bold;
            font-size: 10px;
        }
        .draggable2 {
            position: relative;
            top: 10px;
            left: 10px;
            width: 50px;
            height: 50px;
            background-color: #ff9900;
            color: white;
            text-align: center;
            line-height: 50px;
            cursor: move;
            font-weight: bold;
            font-size: 10px;
        }
        .draggable3 {
            position: relative;
            top: 10px;
            left: 10px;
            width: 50px;
            height: 50px;
            background-color: #0000ff;
            color: white;
            text-align: center;
            line-height: 50px;
            cursor: move;
            font-weight: bold;
            font-size: 10px;
        }
        .draggable4 {
            position: relative;
            top: 10px;
            left: 10px;
            width: 50px;
            height: 50px;
            background-color: #ffa500;
            color: white;
            text-align: center;
            line-height: 50px;
            cursor: move;
            font-weight: bold;
            font-size: 10px;
        }
        .draggable5 {
            position: relative;
            top: 10px;
            left: 10px;
            width: 50px;
            height: 50px;
            background-color: #8b4513; /* Brown color for Cone */
            color: white;
            text-align: center;
            line-height: 50px;
            cursor: move;
            font-weight: bold;
            font-size: 10px;
        }
        .address-bar {
            position: absolute;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 10;
            display: flex;
        }
        .address-input {
            width: 300px;
            padding: 5px;
            font-size: 14px;
        }
        .address-button {
            padding: 5px 10px;
            font-size: 14px;
            cursor: pointer;
        }
        .navigation-bar {
            position: absolute;
            top: 50px; /* Adjust as needed */
            left: 50%;
            transform: translateX(-50%);
            z-index: 10;
            display: flex;
        }
        .mapboxgl-ctrl-bottom-left {
            position: absolute;
            bottom: 0.1%;
            left: 50%;
            transform: translate(-50%, -50%);
        }
        /* Style for map style buttons */
        .map-style-buttons {
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 10;
        }
        .map-style-buttons button {
            background-color: white;
            color: black;
            border: none;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            margin-bottom: 5px;
            cursor: pointer;
        }
        /* Style for add marker button */
        .add-marker-button {
            position: absolute;
            bottom: 10px;
            right: 10px;
            z-index: 10;
            background-color: white;
            color: black;
            border: none;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <script src="https://cdn.jsdelivr.net/gh/jscastro76/threebox@v.2.2.2/dist/threebox.min.js" type="text/javascript"></script>
    <link href="https://cdn.jsdelivr.net/gh/jscastro76/threebox@v.2.2.2/dist/threebox.css" rel="stylesheet" />
    <div id="map"></div>
    <div class="address-bar">
        <input type="text" id="address" class="address-input form-control" placeholder="Enter address or postal code" />
        <button id="fly-button" class="address-button btn btn-primary">Fly to</button>
    </div>
    <div class="navigation-bar">
        <input type="text" id="navigation-address" class="address-input form-control" placeholder="Enter destination address or postal code" />
        <button id="navigate-button" class="address-button btn btn-primary">Navigate</button>
    </div>
    <div id="draggable-truck" class="draggable" draggable="true">Truck</div>
    <div id="draggable-craft" class="draggable2" draggable="true">Craft</div>
    <div id="draggable-washroom" class="draggable3" draggable="true">Washroom</div>
    <div id="draggable-utility" class="draggable4" draggable="true">Utility</div>
    <div id="draggable-cone" class="draggable5" draggable="true">Cone</div>
    <!-- Map style buttons -->
    <div class="map-style-buttons">
        <button id="satellite-button">S</button>
        <button id="streets-button">T</button>
        <button id="dark-button">D</button>
    </div>
    <!-- Add marker button -->
    <button id="add-marker" class="add-marker-button">+</button>
    <script>
        mapboxgl.accessToken = "pk.eyJ1IjoicHVycGhhY3RzIiwiYSI6ImNsdzY1bzVvNzFwb3IyamxyOG1vY3oyM2gifQ.2LikTeWKwlWsAcEneBXW0Q";
        const map = new mapboxgl.Map({
            container: "map",
            style: "mapbox://styles/mapbox/light-v11",
            center: { lng: -79.3871, lat: 43.6426 },
            zoom: 16
        });

        // Get user's current location and add a marker
        map.on("load", () => {
            // Add marker for the initial location
            const initialMarker = new mapboxgl.Marker()
                .setLngLat([-79.3871, 43.6426])
                .addTo(map);

            // Get user's current location and add a marker
            navigator.geolocation.getCurrentPosition(
                (position) => {
                    const { longitude, latitude } = position.coords;
                    const userMarker = new mapboxgl.Marker({ color: "blue" }) // Change marker color to blue for the user's location
                        .setLngLat([longitude, latitude])
                        .addTo(map);

                    // Ensure both markers are visible by fitting the map bounds to include both markers
                    const bounds = new mapboxgl.LngLatBounds();
                    bounds.extend(initialMarker.getLngLat());
                    bounds.extend(userMarker.getLngLat());
                    map.fitBounds(bounds, { padding: 100 }); // Adjust padding as needed
                },
                (error) => {
                    console.error("Error getting user location:", error);
                }
            );
        });

        const tb = (window.tb = new Threebox(
            map,
            map.getCanvas().getContext("webgl"),
            {
                defaultLights: true,
                enableSelectingObjects: true,
                enableDraggingObjects: true,
                enableRotatingObjects: true,
            }
        ));

        map.on("style.load", () => {
            map.addLayer({
                id: "custom-threebox-model",
                type: "custom",
                renderingMode: "3d",
                onAdd: function () {
                    const scale = 3.2;
                    const options = {
                        obj: "https://raw.githubusercontent.com/namtonnest/3dmodels/main/truck.gltf",
                        type: "gltf",
                        scale: { x: scale, y: scale, z: 2.7 },
                        units: "meters",
                        rotation: { x: 90, y: 0, z: 0 },
                        anchor: "center",
                    };
                    const object = tb.loadObj(options, (model) => {
                        const obj = model.setCoords([lon, lat]);
                        tb.add(obj);
                        // Add animation to the model
                        const animateModel = () => {
                            model.setRotation({ x: 0, y: 0, z: (model.rotation.z += 0.01) });
                            requestAnimationFrame(animateModel);
                        };
                        animateModel();
                    });
                },
                render: function (gl, matrix) {
                    tb.update();
                },
            });
        });

        document.getElementById('fly-button').addEventListener('click', () => {
    const address = document.getElementById('address').value;
    if (address) {
        fetch(`https://api.mapbox.com/geocoding/v5/mapbox.places/${encodeURIComponent(address)}.json?access_token=${mapboxgl.accessToken}`)
            .then(response => {
                console.log('Response received:', response);
                return response.json();
            })
            .then(data => {
                console.log('Data received:', data);
                const [lng, lat] = data.features[0].center;
                map.flyTo({ center: [lng, lat], essential: true, zoom: 16 });
            })
            .catch(error => console.error('Error:', error));
    }
});


        document.getElementById('navigate-button').addEventListener('click', () => {
            const address = document.getElementById('navigation-address').value;
            if (address) {
                fetch(`https://api.mapbox.com/geocoding/v5/mapbox.places/${encodeURIComponent(address)}.json?access_token=${mapboxgl.accessToken}`)
                    .then(response => response.json())
                    .then(data => {
                        const [lng, lat] = data.features[0].center;
                        // Implement your navigation logic here
                        // For example, you can draw a route on the map from the current location to the destination
                    });
            }
        });

        // Drag and drop functionality for draggable elements
        const draggables = document.querySelectorAll('.draggable, .draggable2, .draggable3, .draggable4, .draggable5');
        draggables.forEach(draggable => {
            draggable.addEventListener('dragstart', (event) => {
                event.dataTransfer.setData('text/plain', draggable.id);
            });
        });

        map.on('dragover', (event) => {
            event.preventDefault();
        });

        map.on('drop', (event) => {
            event.preventDefault();
            const draggableId = event.dataTransfer.getData('text/plain');
            const draggableElement = document.getElementById(draggableId);
            const { lng, lat } = map.unproject([event.originalEvent.clientX, event.originalEvent.clientY]);
            const marker = new mapboxgl.Marker(draggableElement)
                .setLngLat([lng, lat])
                .addTo(map);
        });

        // Map style buttons
        document.getElementById('satellite-button').addEventListener('click', () => {
            map.setStyle('mapbox://styles/mapbox/satellite-v9');
        });

        document.getElementById('streets-button').addEventListener('click', () => {
            map.setStyle('mapbox://styles/mapbox/streets-v11');
        });

        document.getElementById('dark-button').addEventListener('click', () => {
            map.setStyle('mapbox://styles/mapbox/dark-v10');
        });

        // Add marker button
        document.getElementById('add-marker').addEventListener('click', () => {
            const marker = new mapboxgl.Marker()
                .setLngLat(map.getCenter())
                .addTo(map);
        });
    </script>
</body>
</html>
